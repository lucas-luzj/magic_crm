# Magic CRM 通知接口配置和使用文档

## 概述

Magic CRM 系统集成了多种通知渠道，包括邮件、短信、微信、钉钉和推送通知。本文档详细介绍如何配置和使用这些通知接口。

## 系统架构

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   前端界面      │    │   后端服务       │    │   第三方服务    │
│                 │    │                  │    │                 │
│ 系统设置页面    │◄──►│ NotificationSend │◄──►│ 邮件/短信/微信  │
│ 通知管理页面    │    │ Service          │    │ 钉钉/推送服务   │
│ 通知设置页面    │    │                  │    │                 │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

## 1. 系统设置配置

### 1.1 访问系统设置

1. 登录系统后，在左侧菜单中找到"系统设置"
2. 点击进入系统设置页面
3. 系统设置按功能分组显示：
   - 邮件配置
   - 短信配置
   - 微信配置
   - 钉钉配置
   - 推送配置
   - 系统配置
   - 安全配置
   - 通知配置
   - 文件配置

### 1.2 邮件配置

#### 必需配置项
- **SMTP服务器地址** (`email.smtp.host`): 邮件服务器地址
- **SMTP端口** (`email.smtp.port`): 通常为 587 或 465
- **SMTP用户名** (`email.smtp.username`): 邮箱账号
- **SMTP密码** (`email.smtp.password`): 邮箱密码或授权码
- **发件人邮箱** (`email.from.address`): 系统发送邮件的发件人地址
- **发件人名称** (`email.from.name`): 系统发送邮件的发件人名称

#### 可选配置项
- **启用SMTP认证** (`email.smtp.auth`): 是否启用SMTP认证，默认true
- **启用STARTTLS** (`email.smtp.starttls`): 是否启用STARTTLS加密，默认true

#### 常见邮件服务商配置

**Gmail配置示例：**
```
SMTP服务器地址: smtp.gmail.com
SMTP端口: 587
启用SMTP认证: true
启用STARTTLS: true
```

**QQ邮箱配置示例：**
```
SMTP服务器地址: smtp.qq.com
SMTP端口: 587
启用SMTP认证: true
启用STARTTLS: true
```

**企业邮箱配置示例：**
```
SMTP服务器地址: smtp.exmail.qq.com
SMTP端口: 587
启用SMTP认证: true
启用STARTTLS: true
```

### 1.3 短信配置

#### 阿里云短信配置
- **短信服务商** (`sms.provider`): 设置为 "aliyun"
- **AccessKeyId** (`sms.aliyun.accessKeyId`): 阿里云AccessKeyId
- **AccessKeySecret** (`sms.aliyun.accessKeySecret`): 阿里云AccessKeySecret
- **短信签名** (`sms.aliyun.signName`): 短信签名名称
- **短信模板代码** (`sms.aliyun.templateCode`): 短信模板代码

#### 获取阿里云短信配置步骤
1. 登录阿里云控制台
2. 进入短信服务控制台
3. 创建AccessKey（如果还没有）
4. 申请短信签名
5. 申请短信模板
6. 将相关信息配置到系统中

### 1.4 微信配置

#### 企业微信配置
- **企业微信CorpID** (`wechat.corpId`): 企业微信CorpID
- **企业微信Secret** (`wechat.corpSecret`): 企业微信应用Secret
- **企业微信AgentID** (`wechat.agentId`): 企业微信应用AgentID

#### 获取企业微信配置步骤
1. 登录企业微信管理后台
2. 进入应用管理
3. 创建或选择应用
4. 获取CorpID、Secret和AgentID
5. 将相关信息配置到系统中

### 1.5 钉钉配置

#### 钉钉机器人配置
- **钉钉AppKey** (`dingtalk.appKey`): 钉钉应用AppKey
- **钉钉AppSecret** (`dingtalk.appSecret`): 钉钉应用AppSecret
- **钉钉Webhook地址** (`dingtalk.webhookUrl`): 钉钉机器人Webhook地址

#### 获取钉钉配置步骤
1. 登录钉钉开放平台
2. 创建企业内部应用
3. 获取AppKey和AppSecret
4. 或者创建群机器人获取Webhook地址
5. 将相关信息配置到系统中

### 1.6 推送配置

#### 极光推送配置
- **推送服务商** (`push.provider`): 设置为 "jpush"
- **极光推送AppKey** (`push.jpush.appKey`): 极光推送应用AppKey
- **极光推送MasterSecret** (`push.jpush.masterSecret`): 极光推送MasterSecret
- **生产环境** (`push.jpush.isProduction`): 是否为生产环境，默认false

#### 获取极光推送配置步骤
1. 登录极光推送控制台
2. 创建应用
3. 获取AppKey和MasterSecret
4. 将相关信息配置到系统中

## 2. 通知设置配置

### 2.1 用户通知设置

每个用户可以配置自己的通知偏好：

1. 进入"通知设置"页面
2. 配置各渠道的启用状态：
   - 站内信通知
   - 邮件通知
   - 短信通知
   - 微信通知
   - 钉钉通知
   - 推送通知

3. 配置通知时间：
   - 邮件通知时间
   - 短信通知时间
   - 免打扰时间段

4. 配置通知类型：
   - 工作流通知
   - 任务通知
   - 系统通知

### 2.2 通知模板管理

1. 进入"通知模板"页面
2. 创建或编辑通知模板
3. 配置模板内容，支持变量替换：
   - `{userName}`: 用户姓名
   - `{processName}`: 流程名称
   - `{taskName}`: 任务名称
   - `{actionUrl}`: 操作链接

## 3. 通知接口使用

### 3.1 发送通知

#### 通过服务类发送
```java
@Autowired
private NotificationService notificationService;

// 发送站内信
notificationService.sendNotification(
    userId, 
    "任务提醒", 
    "您有一个新的任务需要处理", 
    NotificationType.TASK, 
    NotificationChannel.IN_SITE, 
    null
);

// 发送邮件
notificationService.sendNotification(
    userId, 
    "流程审批", 
    "请审批流程：请假申请", 
    NotificationType.WORKFLOW, 
    NotificationChannel.EMAIL, 
    null
);
```

#### 通过工作流监听器自动发送
系统会自动在工作流事件发生时发送通知：
- 任务创建时
- 任务完成时
- 流程启动时
- 流程完成时

### 3.2 测试通知配置

#### 在系统设置页面测试
1. 进入系统设置页面
2. 找到需要测试的配置项
3. 点击"测试"按钮
4. 输入测试参数
5. 点击"发送测试"

#### 通过API测试
```bash
# 测试邮件配置
curl -X POST http://localhost:8080/api/system-settings/test/email \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "content": "测试邮件"}'

# 测试短信配置
curl -X POST http://localhost:8080/api/system-settings/test/sms \
  -H "Content-Type: application/json" \
  -d '{"phone": "13800138000", "content": "测试短信"}'
```

## 4. 通知类型和渠道

### 4.1 通知类型
- **TASK**: 任务通知
- **WORKFLOW**: 工作流通知
- **SYSTEM**: 系统通知
- **REMINDER**: 提醒通知

### 4.2 通知渠道
- **IN_SITE**: 站内信
- **EMAIL**: 邮件
- **SMS**: 短信
- **WECHAT**: 微信
- **DINGTALK**: 钉钉
- **PUSH**: 推送

### 4.3 通知优先级
- **LOW**: 低优先级
- **NORMAL**: 普通优先级
- **HIGH**: 高优先级
- **URGENT**: 紧急优先级

## 5. 常见问题解决

### 5.1 邮件发送失败
**问题**: 邮件发送失败，提示认证失败
**解决方案**:
1. 检查SMTP用户名和密码是否正确
2. 确认邮箱是否开启了SMTP服务
3. 检查是否使用了授权码而不是登录密码
4. 确认SMTP服务器地址和端口是否正确

### 5.2 短信发送失败
**问题**: 短信发送失败，提示签名不合法
**解决方案**:
1. 检查短信签名是否在阿里云控制台审核通过
2. 确认短信模板是否审核通过
3. 检查AccessKeyId和AccessKeySecret是否正确
4. 确认手机号格式是否正确

### 5.3 微信消息发送失败
**问题**: 微信消息发送失败，提示access_token无效
**解决方案**:
1. 检查CorpID和Secret是否正确
2. 确认应用是否有发送消息的权限
3. 检查用户是否在企业微信中
4. 确认AgentID是否正确

### 5.4 钉钉消息发送失败
**问题**: 钉钉消息发送失败，提示webhook地址无效
**解决方案**:
1. 检查Webhook地址是否正确
2. 确认机器人是否已启用
3. 检查AppKey和AppSecret是否正确
4. 确认用户是否在钉钉群中

### 5.5 推送发送失败
**问题**: 推送发送失败，提示AppKey无效
**解决方案**:
1. 检查AppKey和MasterSecret是否正确
2. 确认应用是否在极光推送控制台创建成功
3. 检查是否为生产环境配置
4. 确认用户设备是否注册成功

## 6. 监控和日志

### 6.1 通知发送状态
系统会记录每个通知的发送状态：
- **PENDING**: 待发送
- **SENT**: 发送成功
- **FAILED**: 发送失败
- **ARCHIVED**: 已归档

### 6.2 查看发送日志
1. 进入"通知管理"页面
2. 查看通知列表
3. 点击通知详情查看发送状态和错误信息

### 6.3 重试机制
系统会自动重试发送失败的通知：
- 最大重试次数：3次
- 重试间隔：60秒
- 超过重试次数后标记为失败

## 7. 性能优化建议

### 7.1 异步发送
所有通知都采用异步发送，不会阻塞主业务流程。

### 7.2 批量发送
系统支持批量发送通知，提高发送效率。

### 7.3 频率限制
可以配置通知发送频率限制，避免过于频繁的通知。

### 7.4 免打扰时间
用户可以设置免打扰时间段，在指定时间内不发送通知。

## 8. 安全注意事项

### 8.1 敏感信息保护
- 密码和密钥等敏感信息在数据库中加密存储
- 日志中不记录敏感信息
- 定期更换API密钥

### 8.2 权限控制
- 只有管理员可以修改系统设置
- 用户可以修改自己的通知设置
- 通知发送需要相应的权限

### 8.3 数据备份
- 定期备份通知配置
- 备份通知发送记录
- 建立灾难恢复计划

## 9. 更新和维护

### 9.1 定期检查
- 定期检查第三方服务的API状态
- 监控通知发送成功率
- 及时处理发送失败的通知

### 9.2 配置更新
- 及时更新第三方服务的配置信息
- 定期更换API密钥
- 更新通知模板内容

### 9.3 系统升级
- 升级前备份配置
- 测试新版本的通知功能
- 逐步迁移到新版本

---

## 联系支持

如果您在使用过程中遇到问题，请联系技术支持团队：
- 邮箱：support@magiccrm.com
- 电话：400-123-4567
- 在线客服：系统内右下角客服按钮

---

*本文档最后更新时间：2024年12月*
